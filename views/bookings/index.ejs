
<% layout("layouts/boilerplate") %>
<div class="container mt-4">
  <h2 class="mb-4 fw-bold text-center text-primary">🧾 Your Bookings</h2>

  <% if (bookings.length === 0) { %>
    <div class="alert alert-info text-center">You don’t have any bookings yet.</div>
  <% } %>

  <div class="row row-cols-1 row-cols-md-2 g-4">
    <% for(let booking of bookings) { %>
      <div class="col">
        <div class="card shadow-sm h-100 border-0">
          <% if (booking.listing.image?.url) { %>
            <img src="<%= booking.listing.image.url %>" class="card-img-top" style="object-fit: cover; height: 200px;" alt="Listing image">
          <% } %>
          <div class="card-body d-flex flex-column">
            <h5 class="card-title d-flex justify-content-between align-items-center">
              <span><%= booking.listing.title %></span>
              <% if (booking.isPaid) { %>
                <span class="badge bg-success">Paid</span>
              <% } else { %>
                <span class="badge bg-warning text-dark">Pending</span>
              <% } %>
            </h5>
            <p class="card-text mb-1">🗓️ <strong>Check-in:</strong> <%= booking.checkIn.toDateString() %></p>
            <p class="card-text mb-1">🗓️ <strong>Check-out:</strong> <%= booking.checkOut.toDateString() %></p>
            <p class="card-text mb-1">👥 <strong>Guests:</strong> <%= booking.guests %></p>
            <p class="card-text mb-3">💰 <strong>Total:</strong> ₹ <%= booking.totalPrice.toLocaleString("en-IN") %></p>

            <% if (!booking.isPaid) { %>
              <form action="/create-checkout-session/<%= booking._id %>" method="POST">
                <button class="btn btn-primary w-100 mb-2 d-flex align-items-center justify-content-center gap-2 shadow-sm"
                        style="background: linear-gradient(to right, #6772e5, #5469d4); border: none;">
                  <img src="https://cdn-icons-png.flaticon.com/512/196/196565.png" width="18" height="18">
                  Pay Now
                </button>
              </form>
            <% } %>

            <% if (paymentStatus === 'success' && paymentBookingId === booking._id.toString()) { %>
              <div class="alert alert-success text-center">✅ Payment successful! Your booking is confirmed.</div>
            <% } else if (paymentStatus === 'cancelled' && paymentBookingId === booking._id.toString()) { %>
              <div class="alert alert-warning text-center">⚠️ Payment was cancelled. Please try again.</div>
            <% } %>

            <% if (!booking.isPaid) { %>
              <form action="/bookings/<%= booking._id %>?_method=DELETE" method="POST"
                    onsubmit="return confirm('Are you sure you want to cancel this booking?');">
                <button class="btn btn-outline-danger w-100">Cancel Booking</button>
              </form>
            <% } else { %>
              <button class="btn btn-secondary w-100 mt-2" disabled>Cancellation Disabled (Paid)</button>
            <% } %>
          </div>
        </div>
      </div>
    <% } %>
  </div>
</div>




